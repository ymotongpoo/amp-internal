<!DOCTYPE html>
<html lang="en-us">

<head>
  
  
  <meta charset="UTF-8">
  <meta property="og:title" content="Generating AMP JS" />
  <meta property="og:type" content="article" />
  <meta property="og:url" contnet="https://ymotongpoo.github.io/amp-internal/post/gulp/" />
  <meta property="og:image" content="" />
  <meta property="og:site_name" content="AMP internal" />
  <meta property="og:description" content="Preface Before digging into the repository of AMP HTML, let&rsquo;s see how AMP elements works in the browser at first hand. The specification of AMP HTML tag set is combination of subset of HTML5 and custom elements. All builtin custom elements and whole AMP runtime is implemented in AMP JS, which is hosted in the wild on https://cdn.ampproject.org/v0.js. Other third party extensional custom elements, such as amp-analytics, amp-ad and so on are handled in special JavaScript with the elements&rsquo; names." />
  <meta property="og:locale" content="ja_JP" />
  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:url" content="https://ymotongpoo.github.io/amp-internal/post/gulp/" />
  <meta name="twitter:title" content="Generating AMP JS" />
  <meta name="twitter:description" content="Preface Before digging into the repository of AMP HTML, let&rsquo;s see how AMP elements works in the browser at first hand. The specification of AMP HTML tag set is combination of subset of HTML5 and custom elements. All builtin custom elements and whole AMP runtime is implemented in AMP JS, which is hosted in the wild on https://cdn.ampproject.org/v0.js. Other third party extensional custom elements, such as amp-analytics, amp-ad and so on are handled in special JavaScript with the elements&rsquo; names." />
  <meta name="twitter:image" content="" />
  
  

  <link rel="stylesheet" href='/amp-internal/css/main.css'>
  <link rel="stylesheet" href='/amp-internal/css/monokai-sublime.css'>

  <title>Generating AMP JS | AMP internal </title>
</head>

<body>
  <header>
    <div id="social">
      
        <span><a href="https://twitter.com/amphtml/">Twitter</a></span>
      
      
        <span><a href="https://github.com/ampproject">GitHub</a></span>
      
      
    </div>
    
    <div id="branding">
      <h1><a href="https://ymotongpoo.github.io/amp-internal/">AMP internal</a></h1>
      <h2>Unofficial source code analysis of ampproject/amphtml</h2>
    </div>
  </header>
  <main id="index">
    <article>
      <h1>Generating AMP JS</h1>
      <div class="entry-meta">
        <span class="timestamp"><time>2016-10-11 16:14:23</time></span>
        
        
        <span class="tag"><a href='/amp-internal/tags/gulp'>#gulp</a></span>
        
        
        <span class="tag"><a href='/amp-internal/tags/gulpfule.js'>#gulpfule.js</a></span>
        
      </div>
      

<h2 id="preface:c34aea999ea1eeef6ae97c4fa3367837">Preface</h2>

<p>Before digging into the repository of AMP HTML, let&rsquo;s see how AMP elements works in the browser at first hand.</p>

<p>The specification of AMP HTML tag set is combination of subset of HTML5 and custom elements. All builtin custom elements and whole AMP runtime is implemented in AMP JS, which is hosted in the wild on <code>https://cdn.ampproject.org/v0.js</code>.
Other third party extensional custom elements, such as <code>amp-analytics</code>, <code>amp-ad</code> and so on are handled in special JavaScript with the elements&rsquo; names.</p>

<p>The following snippets is from existing AMP page in the production.</p>

<pre><code class="language-html">&lt;script custom-element=&quot;amp-font&quot; src=&quot;https://cdn.ampproject.org/v0/amp-font-0.1.js&quot; async&gt;&lt;/script&gt;
&lt;script custom-element=&quot;amp-ad&quot; src=&quot;https://cdn.ampproject.org/v0/amp-ad-0.1.js&quot; async&gt;&lt;/script&gt;
&lt;script custom-element=&quot;amp-analytics&quot; src=&quot;https://cdn.ampproject.org/v0/amp-analytics-0.1.js&quot; async&gt;&lt;/script&gt;
...
&lt;script src=&quot;https://cdn.ampproject.org/v0.js&quot; async&gt;&lt;/script&gt;
</code></pre>

<p>All JavaScripts for AMP are hosted under <code>https://cdn.ampproject.org/</code>. So it seems that we should take a look at where all those JavaScripts are located, or generated in the repository.</p>

<p>You may find that there&rsquo;s no file named <code>v0.js</code> in the repository once you hit the <code>find</code> command on the console. Also, you may find thet there&rsquo;s no files with the name of <code>[CUSTOM ELEMENT NAME]-[VERSION].js</code> neither, though you find directories under <code>extensions</code> directory that look dedicated for each custom elements, such as <code>amp-ad</code>, <code>amp-audio</code> and so on.</p>

<p>The reason of this is because there JavaScript files are generated by the process run by <code>gulp</code>. So let&rsquo;s take a look at <code>gulpfile.js</code> and understand how these files are generated.</p>

<h2 id="compilejs:c34aea999ea1eeef6ae97c4fa3367837">compileJs()</h2>

<p>As soon as searching the string <code>'v0.js'</code> in the <code>gulpfile.js</code>, you&rsquo;ll find the function <code>compile()</code> that runs <code>compileJs()</code> for a couple of times, <code>compileCss()</code> and <code>thirdPartyBootstrap()</code>. Since what we are interested in is <code>v0.js</code>, <code>compileJs()</code> would give some hints for the generation process of <code>v0.js</code>.</p>

<pre><code class="language-js">/**
 * Compile a javascript file
 *
 * @param {string} srcDir Path to the src directory
 * @param {string} srcFilename Name of the JS source file
 * @param {string} destDir Destination folder for output script
 * @param {?Object} options
 */
function compileJs(srcDir, srcFilename, destDir, options) {
</code></pre>

<p>The function definition and comments with it describes well how it works. The function call in <code>compile()</code> to generate <code>v0.js</code> is following:</p>

<pre><code class="language-js">  // For compilation with babel we start with the amp-babel entry point,
  // but then rename to the amp.js which we've been using all along.
  compileJs('./src/', 'amp-babel.js', './dist', {
    toName: 'amp.js',
    minifiedName: 'v0.js',
    includePolyfills: true,
    checkTypes: opt_checkTypes,
    watch: watch,
    preventRemoveAndMakeDir: opt_preventRemoveAndMakeDir,
    minify: shouldMinify,
    // If there is a sync JS error during initial load,
    // at least try to unhide the body.
    wrapper: 'try{(function(){&lt;%= contents %&gt;})()}catch(e){' +
        'setTimeout(function(){' +
        'var s=document.body.style;' +
        's.opacity=1;' +
        's.visibility=&quot;visible&quot;;' +
        's.animation=&quot;none&quot;;' +
        's.WebkitAnimation=&quot;none;&quot;},1000);throw e};'
  });
</code></pre>

<p>Though I&rsquo;m not a babel expert, the function call sounds like creating <code>./dist/v0.js</code> in some condition. With that expectation, let&rsquo;s take a closer look in <code>compileJs()</code>.</p>

<pre><code class="language-js">function compileJs(srcDir, srcFilename, destDir, options) {
  options = options || {};
  if (options.minify) {
    function minify() {
      console.log('Minifying ' + srcFilename);
      closureCompile(srcDir + srcFilename, destDir, options.minifiedName,
          options)
          .then(function() {
            appendToCompiledFile(srcFilename, destDir + '/' + options.minifiedName);
            fs.writeFileSync(destDir + '/version.txt', internalRuntimeVersion);
            if (options.latestName) {
              fs.copySync(
                  destDir + '/' + options.minifiedName,
                  destDir + '/' + options.latestName);
            }
          });
    }
    minify();
    return;
  }
  ...
</code></pre>

<p>Ok, great. In the internal function <code>minify()</code>, we see the line <code>closureCompile(srcDir + srcFilename, destDir, options.minifiedName, options)</code>. <sup class="footnote-ref" id="fnref:c34aea999ea1eeef6ae97c4fa3367837:gulp1"><a rel="footnote" href="#fn:c34aea999ea1eeef6ae97c4fa3367837:gulp1">1</a></sup> <code>closureCompile()</code> is imported from <code>build-system/tasks/compile.js</code>.</p>

<pre><code class="language-js">// Compiles AMP with the closure compiler. This is intended only for
// production use. During development we intent to continue using
// babel, as it has much faster incremental compilation.
exports.closureCompile = function(entryModuleFilename, outputDir,
    outputFilename, options) {
  // Rate limit closure compilation to MAX_PARALLEL_CLOSURE_INVOCATIONS
  // concurrent processes.
  return new Promise(function(resolve) {
    function start() {
      inProgress++;
      compile(entryModuleFilename, outputDir, outputFilename, options)
          .then(function() {
            inProgress--;
            next();
            resolve();
          }, function(e) {
            console./*OK*/error('Compilation error', e.message);
            process.exit(1);
          });
    }
    function next() {
      if (!queue.length) {
        return;
      }
      if (inProgress &lt; MAX_PARALLEL_CLOSURE_INVOCATIONS) {
        queue.shift()();
      }
    }
    queue.push(start);
    next();
  });
};
</code></pre>

<p>It seems the internal function <code>start()</code> inside Promise() is doing something, because it is pushed to the array variable <code>queue</code> at the end of the Promise and called in the internal function <code>next()</code> that is called at the very last of the Promise. (<code>queue.shift()()</code> is.)</p>

<p>And the function <code>compile()</code> is implemented like this.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:c34aea999ea1eeef6ae97c4fa3367837:gulp1"><code>appendToCompileFile()</code> is called only in the case of the <code>srcFilename</code> is <code>&quot;amp-viz-vega.js&quot;</code> so ignore it in this case.
 <a class="footnote-return" href="#fnref:c34aea999ea1eeef6ae97c4fa3367837:gulp1"><sup>[return]</sup></a></li>
</ol>
</div>

    </article>
  </main>
  <nav>
    
    
  </nav>
  <footer>
    <p class="copyright">source code in the docuements are all from AMP team under Apache License 2.0. texts are under Apache License 2.0.</p>
  </footer>
  <script src='/amp-internal/js/highlight.pack.js'></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
</body>

</html>